name: Final Project Automation

on:
  issues:
    types: [opened, closed, assigned, labeled]
  pull_request:
    types: [opened, closed, merged]
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  automate-project:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Add item to project and update status
      uses: actions/github-script@v7
      with:
        script: |
          const { issue, pull_request } = context.payload;
          const item = issue || pull_request;
          
          if (!item) {
            console.log('No item found in payload');
            return;
          }
          
          console.log(`Processing ${context.eventName} event for ${item.number}`);
          
          // First, add the item to the project if it's not already there
          try {
            const addToProjectMutation = `
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "PVT_kwHOAulTL84BGJsZ"
                  contentId: "${issue ? item.node_id : item.node_id}"
                }) {
                  item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(addToProjectMutation);
            console.log(`Added ${context.eventName} #${item.number} to project`);
          } catch (error) {
            if (error.message.includes('already exists')) {
              console.log(`Item already in project`);
            } else {
              console.log(`Error adding to project: ${error.message}`);
            }
          }
          
          // Determine target status based on event
          let targetStatusName = null;
          
          if (context.eventName === 'issues') {
            const { action } = context.payload;
            
            if (action === 'assigned') {
              targetStatusName = 'In Progress';
            } else if (action === 'closed') {
              targetStatusName = 'Done';
            } else if (action === 'labeled' && context.payload.label.name === 'in-progress') {
              targetStatusName = 'In Progress';
            } else if (action === 'labeled' && context.payload.label.name === 'completed') {
              targetStatusName = 'Done';
            }
          } else if (context.eventName === 'pull_request') {
            const { action, pull_request } = context.payload;
            
            if (action === 'opened' || action === 'reopened') {
              targetStatusName = 'Code Review';
            } else if (action === 'closed' && context.payload.pull_request.merged) {
              targetStatusName = 'Testing';
            } else if (action === 'closed' && !context.payload.pull_request.merged) {
              targetStatusName = 'Ready';
            }
          }
          
          if (!targetStatusName) {
            console.log('No status change needed for this event');
            // Still add a confirmation comment
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                body: `ðŸŽ¯ **Project Board Updated**: Item added to project board automatically.`
              });
            } catch (error) {
              console.log(`Could not add confirmation comment: ${error.message}`);
            }
            return;
          }
          
          // Get project fields to find status field
          const projectFieldsQuery = `
            query {
              node(id: "PVT_kwHOAulTL84BGJsZ") {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          `;
          
          try {
            const fieldsResult = await github.graphql(projectFieldsQuery);
            const fields = fieldsResult.node.fields.nodes;
            
            const statusField = fields.find(f => f.name === 'Status');
            
            if (!statusField || !statusField.options) {
              console.log('Status field not found');
              return;
            }
            
            // Find the status option
            const targetOption = statusField.options.find(o =>
              o.name === targetStatusName ||
              o.name === `ðŸŸ  ${targetStatusName}` ||
              o.name === `ðŸŸ¡ ${targetStatusName}` ||
              o.name === `ðŸ‘€ ${targetStatusName}` ||
              o.name === `âœ… ${targetStatusName}` ||
              o.name === `ðŸŽ‰ ${targetStatusName}` ||
              o.name === `ðŸš€ ${targetStatusName}` ||
              o.name === `ðŸ§ª ${targetStatusName}` ||
              o.name === `â†©ï¸ ${targetStatusName}`
            );
            
            if (!targetOption) {
              console.log(`Status option '${targetStatusName}' not found`);
              return;
            }
            
            // Find the project item
            const itemQuery = `
              query {
                repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                  ${issue ? 'issue' : 'pullRequest'}(number: ${item.number}) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const itemResult = await github.graphql(itemQuery);
            const node = issue ? itemResult.repository.issue : itemResult.repository.pullRequest;
            const projectItems = node.projectItems.nodes;
            
            const vepProjectItem = projectItems.find(item => item.project.id === "PVT_kwHOAulTL84BGJsZ");
            
            if (!vepProjectItem) {
              console.log(`Project item not found for ${context.eventName} #${item.number}`);
              return;
            }
            
            // Update the project item status
            const updateMutation = `
              mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: "PVT_kwHOAulTL84BGJsZ"
                  itemId: "${vepProjectItem.id}"
                  fieldId: "${statusField.id}"
                  value: {
                    singleSelectOptionId: "${targetOption.id}"
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(updateMutation);
            console.log(`Successfully updated project item status to: ${targetOption.name}`);
            
            // Add confirmation comment
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                body: `ðŸŽ¯ **Project Board Updated**: Moved to "${targetOption.name}" column automatically.`
              });
            } catch (error) {
              console.log(`Could not add confirmation comment: ${error.message}`);
            }
            
          } catch (error) {
            console.log(`Error: ${error.message}`);
            if (error.errors) {
              console.log('GraphQL errors:', JSON.stringify(error.errors, null, 2));
            }
          }